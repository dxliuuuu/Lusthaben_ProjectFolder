<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Glowing Particles + Cinematic Text + Restart</title>
  <audio id="bg-audio" src="./audio/LUSTHABEN Sonic Pi Audio/Air.wav" autoplay loop></audio>
  <audio id="bg-audio" src="./audio/LUSTHABEN Sonic Pi Audio/Ambience.wav" autoplay loop></audio>

  <script>
      const audio = document.getElementById("bg-audio");
  
      audio.volume = 0;        // start silent
      audio.currentTime = 20;  // optional jump
      audio.play();
  
      const fadeDuration = 4000; // 4 seconds
      const step = 50;           // how often to raise volume
      const volumeStep = step / fadeDuration;
  
      let fadeIn = setInterval(() => {
          if (audio.volume < 1) {
              audio.volume = Math.min(1, audio.volume + volumeStep);
          } else {
              clearInterval(fadeIn);
          }
      }, step);
  </script>
  
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { position: absolute; top: 0; left: 0; display: block; }

    #ui {
      z-index: 10;
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: flex; align-items: center; justify-content: center;
      pointer-events: none;
    }
    #container {
      opacity: 0;
      z-index: 11;
      max-width: 60vw;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 24px;
      text-align: center;
      transition: opacity 1.5s ease;
      pointer-events: none;
      padding: 1em;
    }

    #restartBtn {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.8em 1.2em;
      background: rgba(255,255,255,0.1);
      color: white;
      font-family: Arial, sans-serif;
      font-size: 20px;
      border: 1px solid white;
      border-radius: 4px;
      opacity: 0;
      cursor: pointer;
      z-index: 12;
      transition: opacity 2s ease;
    }
    #restartBtn.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div id="ui">
    <div id="container">Loading…</div>
  </div>
  <button id="restartBtn">Restart</button>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js",
      "PointerLockControls": "https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/controls/PointerLockControls.js",
      "EffectComposer": "https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/postprocessing/EffectComposer.js",
      "RenderPass": "https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/postprocessing/RenderPass.js",
      "UnrealBloomPass": "https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/postprocessing/UnrealBloomPass.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { PointerLockControls } from "PointerLockControls";
    import { EffectComposer } from "EffectComposer";
    import { RenderPass } from "RenderPass";
    import { UnrealBloomPass } from "UnrealBloomPass";

    // --- Scene setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    scene.fog = new THREE.FogExp2(0x000000, 0.02);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.toneMapping = THREE.ReinhardToneMapping;
    document.body.append(renderer.domElement);

    // Composer + Bloom
    const composer = new EffectComposer(renderer);
    const renderPass = new RenderPass(scene, camera);
    composer.addPass(renderPass);

    const bloomPass = new UnrealBloomPass(
      new THREE.Vector2(window.innerWidth, window.innerHeight),
      3.0, // strength
      0.1, // radius
      0.15 // threshold
    );
    composer.addPass(bloomPass);

    // Particles
    const particleCount = 10000;
    const particles = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    for (let i = 0; i < particleCount; i++) {
      positions[3 * i] = (Math.random() - 0.5) * 60;
      positions[3 * i + 1] = (Math.random() - 0.5) * 60;
      positions[3 * i + 2] = (Math.random() - 0.5) * 60;
    }
    particles.setAttribute("position", new THREE.BufferAttribute(positions, 3));

    const pMaterial = new THREE.PointsMaterial({
      color: 0xffffff,
      size: 0.05,
      depthWrite: false,
      blending: THREE.AdditiveBlending
    });

    const particleSystem = new THREE.Points(particles, pMaterial);
    scene.add(particleSystem);

    // Lighting
    scene.add(new THREE.AmbientLight(0x222222));
    const pointLight = new THREE.PointLight(0xffffff, 1);
    pointLight.position.set(0, 10, 10);
    scene.add(pointLight);

    // Controls
    const controls = new PointerLockControls(camera, document.body);
    scene.add(controls.getObject());

    document.body.addEventListener("click", () => {
      controls.lock();
    });

    const moveState = { forward: false, backward: false, left: false, right: false };
    window.addEventListener("keydown", (e) => {
      if (e.code === "KeyW") moveState.forward = true;
      else if (e.code === "KeyS") moveState.backward = true;
      else if (e.code === "KeyA") moveState.left = true;
      else if (e.code === "KeyD") moveState.right = true;
    });
    window.addEventListener("keyup", (e) => {
      if (e.code === "KeyW") moveState.forward = false;
      else if (e.code === "KeyS") moveState.backward = false;
      else if (e.code === "KeyA") moveState.left = false;
      else if (e.code === "KeyD") moveState.right = false;
    });

    // Poem Text
    const lines = [
      "You are born into this world today.",
      "You forget where you came from, and the path ahead dissolves before you can even imagine it.",
      "The smoke presses down on you, thick and suffocating, yet your attention stays razor sharp.",
      "You lift your eyes toward the ceiling. A colossal black shape looms, breathing out waves of fog.",
      "The mist is made of countless particles.",
      "It drifts from the upper right corner, descending slowly, wrapping itself around bodies like a cloud lowering over a battlefield.",
      "Faces vanish inside it. Only faint silhouettes remain, flickering in and out of view as if the fog is choosing who may exist.",
      "A sudden, fragile happiness washes over you.",
      "The cloud cools your skin, and for one suspended moment you believe you are truly in the sky.",
      "A bird sings above you.",
      "No –—",
      "It is the metallic cry of industrial machinery, echoing through the dark like something wounded.",
      "You clutch your head as dizziness blooms behind your eyes.",
      "You are born into this world today.",
      "Yesterday has already died. Tomorrow will never arrive.",
      "You live fully, entirely, wordlessly in this dark present."
    ];

    const container = document.getElementById("container");
    let currentIndex = 0;

    let lastLineStartTime = null;
    let restartBtn = document.getElementById("restartBtn");

    function showNextLine() {
      if (currentIndex >= lines.length) return;

      container.style.opacity = 0;

      setTimeout(() => {
        container.textContent = lines[currentIndex];
        container.style.opacity = 1;

        if (currentIndex === lines.length - 1) {
          // start random strobe after last line
          lastLineStartTime = performance.now();
          startRandomStrobe();
        }

        currentIndex++;
        if (currentIndex < lines.length) {
          setTimeout(showNextLine, 8000);
        }
      }, 1500);
    }

    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(showNextLine, 1000);
    });

    // Random strobe logic for last line
    let strobeInterval = null;
    function startRandomStrobe() {
      strobeInterval = setInterval(() => {
        // random opacity flicker
        const o = Math.random() * 0.8 + 0.2;  // between 0.2 and 1.0
        container.style.opacity = o;
      }, 100 + Math.random() * 200); // random interval 100–300 ms

      // after 5 seconds show restart button
      setTimeout(() => {
        if (strobeInterval) {
          clearInterval(strobeInterval);
        }
        container.style.opacity = 1;
        restartBtn.classList.add("visible");
        restartBtn.onclick = () => {
          window.location.href = "./index.html";
        };
      }, 5000);
    }

    // Animation loop
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      const speed = 5;

      if (controls.isLocked) {
        const dir = new THREE.Vector3();
        camera.getWorldDirection(dir);
        dir.y = 0;
        dir.normalize();
        const side = new THREE.Vector3().crossVectors(camera.up, dir).normalize();

        if (moveState.forward) controls.moveForward(speed * delta);
        if (moveState.backward) controls.moveForward(-speed * delta);
        if (moveState.left) controls.moveRight(-speed * delta);
        if (moveState.right) controls.moveRight(speed * delta);
      }

      particleSystem.rotation.y += delta * 0.005;
      composer.render();
    }

    animate();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>